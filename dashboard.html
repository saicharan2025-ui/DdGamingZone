<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DD's Gaming Zone Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #222;
    }

    th, td {
      border: 1px solid #444;
      padding: 10px;
      text-align: center;
    }

    th {
      background: #333;
    }

    button {
      padding: 10px 16px;
      margin: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background: #00ffc8;
      color: #000;
      transition: 0.3s;
    }

    button:hover {
      background: #00bfa6;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .home-btn {
      text-decoration: none;
      background: #00ffc8;
      color: black;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
    }

    .home-btn:hover {
      background-color: #00bfa6;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>üìä DD's Gaming Zone Dashboard</h1>
    <a href="index.html" class="home-btn">üè† Home</a>
  </div>

  <div style="text-align: center;">
    <button onclick="exportToday()">Export Today's Data</button>
    <button onclick="exportPastDays(3)">Export Past 3 Days Combined</button>
    <button onclick="exportIndividualDays(3)">Export Past 3 Days Individually</button>
  </div>

  <table id="sessionTable">
   <thead>
  <tr>
    <th>#</th>
    <th>Name</th>
    <th>Mobile</th>
    <th>Address</th>
    <th>System</th>
    <th>Duration (in hours)</th>
    <th>Amount</th>
    <th>Start Time</th>
  </tr>
</thead>
    <tbody></tbody>
  </table>

  <script>
  async function fetchSessions(days = 1) {
    try {
      const response = await fetch(`/api/get-sessions?days=${days}`);
      const data = await response.json();

      const tableBody = document.getElementById("sessionTableBody");
      tableBody.innerHTML = "";

      let totalEarnings = 0;
      let totalHours = 0;

      data.sessions.forEach((session, index) => {
        const durationInHours = (session.duration / 60).toFixed(2);
        const cost = session.systemNumber.toLowerCase().includes("console") ? 150 : 100;
        const earning = cost;
        totalEarnings += earning;
        totalHours += parseFloat(durationInHours);

        const row = `
          <tr>
            <td>${index + 1}</td>
            <td>${session.name}</td>
            <td>${session.mobile}</td>
            <td>${session.address || '-'}</td>
            <td>${session.systemNumber}</td>
            <td>${durationInHours}</td>
            <td>‚Çπ${earning}</td>
            <td>${new Date(session.createdAt).toLocaleString()}</td>
          </tr>
        `;
        tableBody.insertAdjacentHTML("beforeend", row);
      });

      document.getElementById("summary").innerHTML = `
        <p><strong>Total Bookings:</strong> ${data.sessions.length}</p>
        <p><strong>Total Hours:</strong> ${totalHours.toFixed(2)}</p>
        <p><strong>Total Earnings:</strong> ‚Çπ${totalEarnings}</p>
      `;
    } catch (err) {
      console.error("Failed to fetch sessions", err);
    }
  }

  // Fetch today by default
  fetchSessions();

  document.getElementById("exportToday").addEventListener("click", () => exportTable("today"));
  document.getElementById("exportLast3Days").addEventListener("click", () => exportTable("last3"));
  document.getElementById("exportCombined").addEventListener("click", () => exportTable("combined"));

  function exportTable(type) {
    const table = document.getElementById("sessionTable");
    const rows = Array.from(table.rows);
    let csvContent = "";

    rows.forEach(row => {
      const cols = Array.from(row.cells).map(cell => `"${cell.innerText}"`);
      csvContent += cols.join(",") + "\n";
    });

    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");

    const dateStr = new Date().toISOString().split("T")[0];
    link.setAttribute("href", url);
    link.setAttribute("download", `gaming_sessions_${type}_${dateStr}.csv`);
    link.style.display = "none";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  document.getElementById("goHome").addEventListener("click", () => {
    window.location.href = "/";
  });
</script>
</body>
</html>
