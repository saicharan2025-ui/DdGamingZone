<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DD's Gaming Zone Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: #222;
    }

    th, td {
      border: 1px solid #444;
      padding: 10px;
      text-align: center;
    }

    th {
      background: #333;
    }

    button {
      padding: 10px 16px;
      margin: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background: #00ffc8;
      color: #000;
      transition: 0.3s;
    }

    button:hover {
      background: #00bfa6;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    .home-btn {
      text-decoration: none;
      background: #00ffc8;
      color: black;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
    }

    .home-btn:hover {
      background-color: #00bfa6;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <h1>üìä DD's Gaming Zone Dashboard</h1>
    <a href="index.html" class="home-btn">üè† Home</a>
  </div>

  <div style="text-align: center;">
    <button onclick="exportToday()">Export Today's Data</button>
    <button onclick="exportPastDays(3)">Export Past 3 Days Combined</button>
    <button onclick="exportIndividualDays(3)">Export Past 3 Days Individually</button>
  </div>

  <table id="sessionTable">
    <thead>
      <tr>
        <th>Name</th>
        <th>Mobile</th>
        <th>Address</th>
        <th>System</th>
        <th>Duration (min)</th>
        <th>Start Time</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allSessions = [];

    async function fetchSessions() {
      try {
        const res = await fetch('/api/sessions');
        const data = await res.json();
        allSessions = data;
        renderTable(data);
      } catch (err) {
        console.error('Error fetching sessions:', err);
      }
    }

    function renderTable(data) {
      const tbody = document.querySelector("#sessionTable tbody");
      tbody.innerHTML = "";
      data.forEach(session => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${session.name}</td>
          <td>${session.mobile}</td>
          <td>${session.address || '-'}</td>
          <td>${session.systemNumber}</td>
          <td>${session.duration}</td>
          <td>${new Date(session.startTime).toLocaleString()}</td>
          <td>‚Çπ${session.amount || calculateAmount(session)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function calculateAmount(session) {
      if (session.systemNumber?.toLowerCase().includes("console")) {
        return session.duration * 2.5;
      } else {
        return session.duration * 1.67;
      }
    }

    function exportToday() {
      const today = new Date().toDateString();
      const todayData = allSessions.filter(s => new Date(s.startTime).toDateString() === today);
      exportToExcel(todayData, "Today_Sessions");
    }

    function exportPastDays(n) {
      const now = new Date();
      const filtered = allSessions.filter(s => {
        const d = new Date(s.startTime);
        const daysAgo = (now - d) / (1000 * 60 * 60 * 24);
        return daysAgo <= n;
      });
      exportToExcel(filtered, `Last_${n}_Days_Sessions`);
    }

    function exportIndividualDays(n) {
      const now = new Date();
      for (let i = 0; i < n; i++) {
        const target = new Date(now);
        target.setDate(now.getDate() - i);
        const dayStr = target.toDateString();
        const dayData = allSessions.filter(s => new Date(s.startTime).toDateString() === dayStr);
        if (dayData.length) {
          exportToExcel(dayData, `Session_${dayStr.replace(/ /g, "_")}`);
        }
      }
    }

    function exportToExcel(data, filename) {
      const exportData = data.map(s => ({
        Name: s.name,
        Mobile: s.mobile,
        Address: s.address || '',
        System: s.systemNumber,
        Duration: s.duration,
        StartTime: new Date(s.startTime).toLocaleString(),
        Amount: `‚Çπ${s.amount || calculateAmount(s)}`
      }));

      const ws = XLSX.utils.json_to_sheet(exportData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Sessions");
      XLSX.writeFile(wb, `${filename}.xlsx`);
    }

    fetchSessions();
  </script>
</body>
</html>
