<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DD's Play Arena</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: url('https://png.pngtree.com/thumb_back/fh260/background/20250524/pngtree-dark-themed-chess-composition-with-glowing-metal-king-image_17338044.jpg') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }

    .nav {
      background-color: rgba(0, 0, 0, 0.7);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .nav h2 {
      margin: 0;
    }

    .container {
      padding: 20px;
    }

    form {
      background-color: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 30px;
    }

    form input, form select {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 5px;
    }

    .btn {
      background-color: #28a745;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .card {
      background-color: rgba(255, 255, 255, 0.9);
      color: #000;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .session-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .whatsapp-btn {
      background-color: #25d366;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 5px;
      margin-top: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="nav">
    <h2>ðŸŽ® DD's Play Arena</h2>
    <a href="index.html" style="color:white; text-decoration: none;">Home</a>
  </div>

  <div class="container">
    <form id="sessionForm">
      <h3>Start New Session</h3>
      <input type="text" id="name" placeholder="Player Name" required />
      <input type="text" id="mobile" placeholder="Mobile Number" required />
      <input type="text" id="address" placeholder="Address" required />
      <select id="systemNumber" required>
        <option value="">Select System</option>
        <option value="PC1">PC1</option>
        <option value="PC2">PC2</option>
        <option value="PC3">PC3</option>
        <option value="PC4">PC4</option>
        <option value="PC5">PC5</option>
        <option value="PC6">PC6</option>
        <option value="PS1">PS1</option>
        <option value="PS2">PS2</option>
      </select>
      <input type="number" id="allocatedMinutes" placeholder="Allocated Time (minutes)" required />
      <label><input type="checkbox" id="isChild" /> Below 12 Years?</label><br/>
      <button type="submit" class="btn">Start Session</button>
    </form>

    <h3>ðŸŸ¢ Active Sessions</h3>
    <div class="session-list" id="sessionCards"></div>
  </div>

  <script>
    const sessionForm = document.getElementById("sessionForm");
    const sessionCards = document.getElementById("sessionCards");

    async function loadActiveSessions() {
      const res = await fetch("/api/active-sessions");
      const sessions = await res.json();

      sessionCards.innerHTML = "";
      sessions.forEach(generateSessionCard);
    }

    function generateSessionCard(session) {
      const card = document.createElement("div");
      card.className = "card";

      const now = new Date();
      const startTime = new Date(session.startTime);
      const elapsed = Math.floor((now - startTime) / 60000);
      const remaining = session.allocatedMinutes - elapsed;

      card.innerHTML = `
        <p><strong>Name:</strong> ${session.name}</p>
        <p><strong>System:</strong> ${session.systemNumber}</p>
        <p><strong>Child:</strong> ${session.isChild ? "Yes" : "No"}</p>
        <p><strong>Allocated:</strong> ${session.allocatedMinutes} mins</p>
        <p><strong>Used:</strong> ${elapsed} mins</p>
        <p><strong>Remaining:</strong> ${remaining < 0 ? 0 : remaining} mins</p>
        <button class="btn" onclick="endSession('${session._id}')">End</button>
        ${session.isChild && elapsed >= 60 ? `
          <button class="whatsapp-btn" onclick="notifyParent('${session.name}', '${session.mobile}')">
            Notify Parent
          </button>` : ""}
      `;
      sessionCards.appendChild(card);
    }

    async function endSession(id) {
      if (confirm("End this session?")) {
        await fetch(`/api/end-session/${id}`, { method: "POST" });
        loadActiveSessions();
      }
    }

    function notifyParent(name, mobile) {
      const message = `Hi, We are from DD's Play Arena,your child ${name} has completed 1 hour of gameplay at our Play Arena. Please confirm if they can continue.`;
      const url = `https://web.whatsapp.com/send?phone=91${mobile}&text=${encodeURIComponent(message)}`;
      window.open(url, "_blank");
    }

    sessionForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nameInput = document.getElementById("name");
      const mobileInput = document.getElementById("mobile");
      const addressInput = document.getElementById("address");
      const systemSelect = document.getElementById("systemNumber");
      const allocatedMinutes = document.getElementById("allocatedMinutes");
      const childCheckbox = document.getElementById("isChild");

      const payload = {
        name: nameInput.value,
        mobile: mobileInput.value,
        address: addressInput.value,
        systemNumber: systemSelect.value,
        isChild: childCheckbox.checked,
        allocatedMinutes: parseInt(allocatedMinutes.value) || 60
      };

      const res = await fetch("/api/start-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        sessionForm.reset();
        loadActiveSessions();
      } else {
        alert("Failed to start session.");
      }
    });

    loadActiveSessions();
    setInterval(loadActiveSessions, 30000); // refresh every 30 sec
  </script>
</body>
</html>
